{"name":"服务端","slug":"服务端","count":1,"postlist":[{"title":"天梯分计算逻辑需求","slug":"intern-record","date":"2023-08-27T15:32:02.000Z","updated":"2023-08-27T15:33:53.299Z","comments":true,"path":"api/articles/intern-record.json","excerpt":"","keywords":null,"cover":"https://pxoqzf62udc.feishu.cn/space/api/box/stream/download/asynccode/?code=MzFmNzhiYjQ2ZGRmN2ViMzEzNWFiYWRmYWFmYzFiYTlfckxsZmxEdnNZRkRoN0tBS1hrbXF2OGIzRlJ0TmlWdUlfVG9rZW46TG1iTGJvWDFWbzhKMmV4MXFCemN1QVNKbkxoXzE2OTMxNTAzOTY6MTY5MzE1Mzk5Nl9WNA","content":"<h3 id=\"优化排位赛的匹配规则（含单人排位和组队排位）\"><a href=\"#优化排位赛的匹配规则（含单人排位和组队排位）\" class=\"headerlink\" title=\"优化排位赛的匹配规则（含单人排位和组队排位）\"></a>优化排位赛的匹配规则（含单人排位和组队排位）</h3><p>匹配规则怎么修改，相对比较复杂，该需求可能需要延后</p>\n<p>需要open-match-function的仓库</p>\n<p>需要学习sopen-match的匹配机制</p>\n<p>单人匹配：</p>\n<ul>\n<li>天梯分+已解锁种族</li>\n</ul>\n<p>组队匹配：</p>\n<ul>\n<li>常量表新增字段配置，x分及以上不允许进行组队排位。同时，x分及以上的玩家不会遇到组队排位的对手。<ul>\n<li>不允许x分以上的进行组队排位，由前端在调用邀请接口时，uds返回该玩家天梯分和x的大小比较结果 return player.ladderGrade &lt; x和对应的消息类型MESSAGE_INVITE_UNVALID_LADDERGRADE</li>\n<li>x分以上的玩家只能匹配单排玩家，而不能匹配组排玩家，需要修改open-match中的过滤器的过滤规则。<ul>\n<li>如果x分以上的玩家发起组队邀请，uds会直接返回不能进行组队的反馈，邀请x分以上的玩家时同理</li>\n<li>x分以上的玩家在匹配时，需要修改open-match中的过滤规则，只匹配单排玩家，如果单排玩家不足则使用ai</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>组队排位允许2/3/4人一起排位，队伍的天梯分视为天梯分最高值，天梯分最高的已解锁种族为匹配规则队伍的探索等级视为探索等级最大值。<ul>\n<li>队伍中的最大天梯分和最大已解锁种族作为匹配时的输入，用于匹配规则。</li>\n</ul>\n</li>\n<li>最终结算时，同一队伍按照平均排名来作为每个人的最终排名<ul>\n<li>最终结算时代表一个队伍【我方、敌方】被完全淘汰，此时需要通过和队伍中每个玩家保持的TCP长连接来转发，即可能需要延迟由最终结束战斗的那个客户端触发广播消息给已经被淘汰或者投降的玩家。</li>\n</ul>\n</li>\n<li>最终计算得分时，“对手平均分数”的取值，不包括自身的队友。（鼓励带小号）<ul>\n<li>自身队友指的是自己邀请的队友成员【假设包括自己的成员数为m】，游戏匹配时会自动匹配剩余8-m个玩家，在战斗过程中玩家之间会随即进行战斗，即自己可能和队友进行战斗【?】</li>\n</ul>\n</li>\n</ul>\n<p><img src=\"https://pxoqzf62udc.feishu.cn/space/api/box/stream/download/asynccode/?code=MzFmNzhiYjQ2ZGRmN2ViMzEzNWFiYWRmYWFmYzFiYTlfckxsZmxEdnNZRkRoN0tBS1hrbXF2OGIzRlJ0TmlWdUlfVG9rZW46TG1iTGJvWDFWbzhKMmV4MXFCemN1QVNKbkxoXzE2OTMxNTAzOTY6MTY5MzE1Mzk5Nl9WNA\" alt=\"img\"></p>\n<ol>\n<li><p>基础得分公式：以ELO算法为基础进行调整，公式如下</p>\n<ol>\n<li><script type=\"math/tex; mode=display\">Δx=k*[m-Rank-P(D)]</script></li>\n<li><script type=\"math/tex; mode=display\">P(D)=\\frac{n}{1+10^{-D/t}}</script></li>\n<li><script type=\"math/tex; mode=display\">D=x-\\={y}</script></li>\n</ol>\n</li>\n</ol>\n<h3 id=\"确定天梯分的计算规则，分为单排和多排\"><a href=\"#确定天梯分的计算规则，分为单排和多排\" class=\"headerlink\" title=\"确定天梯分的计算规则，分为单排和多排\"></a>确定天梯分的计算规则，分为单排和多排</h3><p>前端天梯分的显示逻辑是什么样的：</p>\n<ul>\n<li>是后端传回本局的得分，还是传回进行加减后的天梯分</li>\n</ul>\n<p>以前版本的天梯分计算逻辑，会考虑实力修正，连胜、分数保护等</p>\n<figure class=\"highlight protobuf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 战斗结束天梯分变化数据</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">message</span> <span class=\"title\">LadderScoreChangeData</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">int32</span> oldScore = <span class=\"number\">1</span>;    <span class=\"comment\">// 旧分数</span></span><br><span class=\"line\">  <span class=\"built_in\">int32</span> newScore = <span class=\"number\">2</span>;    <span class=\"comment\">// 新分数</span></span><br><span class=\"line\">  <span class=\"built_in\">int32</span> baseScore = <span class=\"number\">3</span>;   <span class=\"comment\">// 基础分</span></span><br><span class=\"line\">  <span class=\"built_in\">int32</span> powerRevise = <span class=\"number\">4</span>; <span class=\"comment\">// 实力修正</span></span><br><span class=\"line\">  <span class=\"built_in\">int32</span> winRevise = <span class=\"number\">5</span>;   <span class=\"comment\">// 连胜分</span></span><br><span class=\"line\">  <span class=\"built_in\">int32</span> saveScore = <span class=\"number\">6</span>;   <span class=\"comment\">// 分数保护</span></span><br><span class=\"line\">  <span class=\"built_in\">int32</span> randomHeroScore = <span class=\"number\">7</span>;  <span class=\"comment\">// 随机英雄分数</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">Δx= baseScore + powerRevise + winRevise</span><br><span class=\"line\">    var conf = Gen.GetKnockoutBattleRewardByFilter(c =&gt; c.Rank == rank &amp;&amp; c.Grade == CurLadderGrade.Id)</span><br><span class=\"line\">        .FirstOrDefault();</span><br><span class=\"line\">    if (conf == null)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        return;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    var baseScore = conf.BaseScore;</span><br><span class=\"line\">    var powerRevise = <span class=\"number\">0</span>;</span><br><span class=\"line\">    var winRevise = <span class=\"number\">0</span>;</span><br><span class=\"line\">    var saveScore = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"comment\">// 实力修正</span></span><br><span class=\"line\">    if (UserData.Ladder.Score &lt;</span><br><span class=\"line\">        BattleRoyale.PlayerAverageLadderScore - BattleRoyale.PlayerStandardDeviationLadderScore)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        powerRevise = conf.PowerRevise;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 连胜修正</span></span><br><span class=\"line\">    <span class=\"comment\">// 大于4时此局失败，不再考虑连胜</span></span><br><span class=\"line\">    const int maxWinRank = <span class=\"number\">4</span>;</span><br><span class=\"line\">    if (rank &lt;= maxWinRank)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        var res = UserDataService.GetLastGameHistory(new GetLastGameHistoryMsg</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            UserId = ID,</span><br><span class=\"line\">            ReqGameMode = Util.GameModeHelper.BuildGameModeNum(BattleRoyale),</span><br><span class=\"line\">            LastCount = (uint) conf.WinsRevise.Count,</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        var winCount = <span class=\"number\">0</span>;</span><br><span class=\"line\">        foreach (var userGameHistoryRecord in res)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            if (userGameHistoryRecord.Result &lt;= maxWinRank)</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                winCount++;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            else</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                break;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        if (winCount &gt; <span class=\"number\">0</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            winRevise = conf.WinsRevise[winCount - <span class=\"number\">1</span>];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"comment\">// 掉分保护</span></span><br><span class=\"line\">    if (baseScore + powerRevise + winRevise &lt; <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        var newLadder =</span><br><span class=\"line\">            CardGameCalculator.Utils.ScoreToLadderGrade(baseScore + powerRevise + winRevise +</span><br><span class=\"line\">                                                        UserData.Ladder.Score);</span><br><span class=\"line\">        if (newLadder.Id != CurLadderGrade.Id)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"comment\">//saveScore + baseScore + powerRevise + winRevise + UserData.Ladder.Score == CurLadderGrade.ScoreList[0]</span></span><br><span class=\"line\">            saveScore = CurLadderGrade.ScoreList[<span class=\"number\">0</span>] - UserData.Ladder.Score - baseScore - powerRevise -</span><br><span class=\"line\">                        winRevise;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    var total = baseScore + powerRevise + winRevise + saveScore;</span><br><span class=\"line\"></span><br><span class=\"line\">    LogHelper.WriteLog(</span><br><span class=\"line\">        $<span class=\"string\">&quot;Player &#123;ID&#125; rank &#123;rank&#125; 段位 &#123;CurLadderGrade.Name&#125;(&#123;CurLadderGrade.Id&#125;) &quot;</span> +</span><br><span class=\"line\">        $<span class=\"string\">&quot;比赛平均分&#123;BattleRoyale.PlayerAverageLadderScore&#125; &quot;</span> +</span><br><span class=\"line\">        $<span class=\"string\">&quot;均差&#123;BattleRoyale.PlayerStandardDeviationLadderScore&#125;&quot;</span> +</span><br><span class=\"line\">        $<span class=\"string\">&quot; 基础分&#123;baseScore&#125; 实力修正&#123;powerRevise&#125; 连胜修正&#123;winRevise&#125; 掉分保护&#123;saveScore&#125;&quot;</span> +</span><br><span class=\"line\">        $<span class=\"string\">&quot;最后得分: &#123;total&#125;&quot;</span>);</span><br><span class=\"line\">    var total = UserData.Ladder.Score + deltaX;</span><br><span class=\"line\">    <span class=\"comment\">// 保存天梯分变化数据</span></span><br><span class=\"line\">    LadderScoreChange = new LadderScoreChangeData</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        OldScore = UserData.Ladder.Score,</span><br><span class=\"line\">        BaseScore = baseScore,</span><br><span class=\"line\">        PowerRevise = powerRevise,</span><br><span class=\"line\">        WinRevise = winRevise,</span><br><span class=\"line\">        SaveScore = saveScore</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    UserData = UserDataUtil.MergeUserData(UserData, UserDataService.UpdateUserLadderScore(ID, total));</span><br><span class=\"line\">    <span class=\"comment\">// 新分数</span></span><br><span class=\"line\">    LadderScoreChange.NewScore = UserData.Ladder.Score;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>单排和多排是如何区分的，多排的话会有一个TeamList的结构，里面包括了组队成员</p>\n<p><script type=\"math/tex\">\\={y} = x - \\sum^{k}_{i=1}{!Team_{me}}/k</script>，其中k表示除了组队好友外的其他成员的个数，x表示本局游戏开始时，当前玩家的天梯分【可能存在还未结算的比赛】</p>\n<h4 id=\"单排：k-7\"><a href=\"#单排：k-7\" class=\"headerlink\" title=\"单排：k = 7\"></a>单排：k = 7</h4><h4 id=\"多排：k-8-组队人数\"><a href=\"#多排：k-8-组队人数\" class=\"headerlink\" title=\"多排：k = 8 - 组队人数\"></a>多排：k = 8 - 组队人数</h4><p>在大厅服生成的Team信息结构如下，会发送给客户端，然后客户端又转发给战斗服</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Team <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    state         protoimpl.MessageState</span><br><span class=\"line\">    sizeCache     protoimpl.SizeCache</span><br><span class=\"line\">    unknownFields protoimpl.UnknownFields</span><br><span class=\"line\"></span><br><span class=\"line\">    Id           <span class=\"keyword\">int32</span>         <span class=\"string\">`protobuf:&quot;varint,1,opt,name=id,proto3&quot; json:&quot;id,omitempty&quot;`</span></span><br><span class=\"line\">    Type         TeamType      <span class=\"string\">`protobuf:&quot;varint,2,opt,name=type,proto3,enum=pb.TeamType&quot; json:&quot;type,omitempty&quot;`</span></span><br><span class=\"line\">    Status       TeamStatus    <span class=\"string\">`protobuf:&quot;varint,3,opt,name=status,proto3,enum=pb.TeamStatus&quot; json:&quot;status,omitempty&quot;`</span></span><br><span class=\"line\">    Host         <span class=\"keyword\">uint64</span>        <span class=\"string\">`protobuf:&quot;varint,4,opt,name=host,proto3&quot; json:&quot;host,omitempty&quot;`</span></span><br><span class=\"line\">    MemberList   []*TeamMember <span class=\"string\">`protobuf:&quot;bytes,5,rep,name=memberList,proto3&quot; json:&quot;memberList,omitempty&quot;`</span></span><br><span class=\"line\">    AiNameList   []<span class=\"keyword\">string</span>      <span class=\"string\">`protobuf:&quot;bytes,6,rep,name=aiNameList,proto3&quot; json:&quot;aiNameList,omitempty&quot;`</span> <span class=\"comment\">// 手动加的ai名字</span></span><br><span class=\"line\">    Ticket       <span class=\"keyword\">string</span>        <span class=\"string\">`protobuf:&quot;bytes,7,opt,name=ticket,proto3&quot; json:&quot;ticket,omitempty&quot;`</span></span><br><span class=\"line\">    MatchConf    *MatchConf    <span class=\"string\">`protobuf:&quot;bytes,8,opt,name=matchConf,proto3&quot; json:&quot;matchConf,omitempty&quot;`</span></span><br><span class=\"line\">    TriggerByUid <span class=\"keyword\">uint64</span>        <span class=\"string\">`protobuf:&quot;varint,9,opt,name=triggerByUid,proto3&quot; json:&quot;triggerByUid,omitempty&quot;`</span> <span class=\"comment\">// 触发把team状态修改的uid</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>压力测试时客户端返回的数据格式，memberlist是和自己组队的用户的信息</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;server&quot;</span>:<span class=\"string\">&quot;a92a048e0254844cb81c46bbe96944c1-873100319.ap-southeast-1.elb.amazonaws.com:1888&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;ticket&quot;</span>:<span class=\"string\">&quot;ZGUFYHOVAJ&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;lobbyId&quot;</span>:<span class=\"string\">&quot;1684486611235436684&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;teamList&quot;</span>:[</span><br><span class=\"line\">        Object&#123;...&#125;,</span><br><span class=\"line\">        Object&#123;...&#125;,</span><br><span class=\"line\">        Object&#123;...&#125;,</span><br><span class=\"line\">        Object&#123;...&#125;,</span><br><span class=\"line\">        Object&#123;...&#125;,</span><br><span class=\"line\">        Object&#123;...&#125;,</span><br><span class=\"line\">        Object&#123;...&#125;,</span><br><span class=\"line\">        Object&#123;...&#125;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">&quot;otherParam&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;ecArg&quot;</span>:<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>启动两个unity客户端，两人组队匹配ai时的返回数据msg，当一个玩家没有解锁全部的时候，没有ladderScore字段，这里需要进行个<strong>判空操作</strong>，使用否则会出现服务端报错。</p>\n<p>组队排位的计算逻辑：</p>\n<p>首先对于每一个player，需要遍历teamList，然后遍历每一个memberList，然后如果该玩家在此memberList中就不计算该memberList中的玩家。</p>\n<p>每个更新天梯分的触发时机</p>\n<ul>\n<li>当前队伍成员全部被淘汰</li>\n<li>游戏结束时，第一名所在队伍成员触发天梯分更新。【这里的逻辑应该是第二名落败后先触发上一个更新节点，然后才是当前的更新节点】</li>\n<li>奖励的发放也应该是天梯分更新后才进行</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;uid&quot;</span>:<span class=\"string\">&quot;10002&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;lobbyId&quot;</span>:<span class=\"string\">&quot;1684680476743412042&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;ticket&quot;</span>:<span class=\"string\">&quot;RZVQANQRNS&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;name&quot;</span>:<span class=\"string\">&quot;eroder2&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;isPublic&quot;</span>:<span class=\"literal\">true</span>,</span><br><span class=\"line\">    <span class=\"comment\">//这里如果有4个双人队伍互相匹配到，teamList就应该size = 4 </span></span><br><span class=\"line\">    <span class=\"attr\">&quot;teamList&quot;</span>:[</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;id&quot;</span>:<span class=\"number\">5690</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;status&quot;</span>:<span class=\"string\">&quot;Matching&quot;</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;host&quot;</span>:<span class=\"string\">&quot;10002&quot;</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;memberList&quot;</span>:[</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"attr\">&quot;id&quot;</span>:<span class=\"string\">&quot;10002&quot;</span>,</span><br><span class=\"line\">                    <span class=\"attr\">&quot;name&quot;</span>:<span class=\"string\">&quot;eroder2&quot;</span>,</span><br><span class=\"line\">                    <span class=\"attr\">&quot;ladderGrade&quot;</span>:<span class=\"number\">1</span>,</span><br><span class=\"line\">                    <span class=\"attr\">&quot;avatar&quot;</span>:<span class=\"string\">&quot;conf://1&quot;</span></span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"attr\">&quot;id&quot;</span>:<span class=\"string\">&quot;10001&quot;</span>,</span><br><span class=\"line\">                    <span class=\"attr\">&quot;name&quot;</span>:<span class=\"string\">&quot;eroder&quot;</span>,</span><br><span class=\"line\">                    <span class=\"attr\">&quot;ladderGrade&quot;</span>:<span class=\"number\">8</span>,</span><br><span class=\"line\">                    <span class=\"attr\">&quot;avatar&quot;</span>:<span class=\"string\">&quot;conf://3&quot;</span>,</span><br><span class=\"line\">                    <span class=\"attr\">&quot;ladderScore&quot;</span>:<span class=\"number\">3915</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            ],</span><br><span class=\"line\">            <span class=\"attr\">&quot;matchConf&quot;</span>:&#123;</span><br><span class=\"line\">                <span class=\"attr\">&quot;weight&quot;</span>:<span class=\"number\">10</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;addAiMinSec&quot;</span>:<span class=\"number\">3</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;addAiMaxSec&quot;</span>:<span class=\"number\">9</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;initPlayerCountMin&quot;</span>:<span class=\"number\">1</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;initPlayerCountMax&quot;</span>:<span class=\"number\">1</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;waitingSecAfterAddPerson&quot;</span>:<span class=\"number\">6</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">&quot;aiNameList&quot;</span>:[</span><br><span class=\"line\">        <span class=\"string\">&quot;MHBb&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;EN_5&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;求同存异&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;晴天云吞&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;那年才秋至&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"attr\">&quot;taConf&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;deviceId&quot;</span>:<span class=\"string\">&quot;81AC2060-E7C2-5826-9960-61213BEAAC09&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;channel&quot;</span>:<span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;zoneOffset&quot;</span>:<span class=\"number\">8</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;version&quot;</span>:<span class=\"string\">&quot;0.1.2&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;deviceModel&quot;</span>:<span class=\"string\">&quot;Mac14,2&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;manufacturer&quot;</span>:<span class=\"string\">&quot;Apple&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;os&quot;</span>:<span class=\"string\">&quot;MacOSX&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;osVersion&quot;</span>:<span class=\"string\">&quot;Mac OS X 13.3.1&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;screenHeight&quot;</span>:<span class=\"number\">1840</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;screenWidth&quot;</span>:<span class=\"number\">2940</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;systemLanguage&quot;</span>:<span class=\"string\">&quot;zh&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;distinctId&quot;</span>:<span class=\"string\">&quot;4a67aa15b8934536b38e8de40e09d2a7&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">&quot;matchParam&quot;</span>:&#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;ecArg&quot;</span>:<span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">&quot;MatchWaitingTime&quot;</span>:<span class=\"number\">-28757</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>启动一个unity客户端时，匹配ai时的返回数据</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;id&quot;</span>:<span class=\"number\">5690</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;status&quot;</span>:<span class=\"string\">&quot;Matching&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;host&quot;</span>:<span class=\"string\">&quot;10002&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;memberList&quot;</span>:[</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"attr\">&quot;id&quot;</span>:<span class=\"string\">&quot;10002&quot;</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;name&quot;</span>:<span class=\"string\">&quot;eroder2&quot;</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;ladderGrade&quot;</span>:<span class=\"number\">1</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;avatar&quot;</span>:<span class=\"string\">&quot;conf://1&quot;</span></span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                <span class=\"attr\">&quot;id&quot;</span>:<span class=\"string\">&quot;10001&quot;</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;name&quot;</span>:<span class=\"string\">&quot;eroder&quot;</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;ladderGrade&quot;</span>:<span class=\"number\">8</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;avatar&quot;</span>:<span class=\"string\">&quot;conf://3&quot;</span>,</span><br><span class=\"line\">                <span class=\"attr\">&quot;ladderScore&quot;</span>:<span class=\"number\">3915</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"attr\">&quot;matchConf&quot;</span>:&#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;weight&quot;</span>:<span class=\"number\">10</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;addAiMinSec&quot;</span>:<span class=\"number\">3</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;addAiMaxSec&quot;</span>:<span class=\"number\">9</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;initPlayerCountMin&quot;</span>:<span class=\"number\">1</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;initPlayerCountMax&quot;</span>:<span class=\"number\">1</span>,</span><br><span class=\"line\">            <span class=\"attr\">&quot;waitingSecAfterAddPerson&quot;</span>:<span class=\"number\">6</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br><span class=\"line\">private List&lt;Reward&gt; BeforeEndGame(int rank)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    private void UpdateDeltaLadderScore(int rank)</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>计算队伍的平均排名，需要保存队伍中的用户排名rank</p>\n<p>修改了proto-tool中的match.proto，新增了rank字段</p>\n<figure class=\"highlight protobuf\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">message</span> <span class=\"title\">TeamMember</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"built_in\">uint64</span> id = <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"built_in\">string</span> name = <span class=\"number\">2</span>;</span><br><span class=\"line\">  <span class=\"built_in\">int32</span> ladderGrade = <span class=\"number\">3</span>;</span><br><span class=\"line\">  <span class=\"built_in\">int32</span> seatId = <span class=\"number\">4</span>;          <span class=\"comment\">// 仅团战关心</span></span><br><span class=\"line\">  <span class=\"built_in\">string</span> avatar = <span class=\"number\">5</span>;</span><br><span class=\"line\">  <span class=\"built_in\">int32</span> ladderScore = <span class=\"number\">6</span>;</span><br><span class=\"line\">  <span class=\"built_in\">int32</span> rank = <span class=\"number\">7</span>; <span class=\"comment\">//临时存储当前玩家的排名</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>修改GameConfConstant配置表，添加elo算法相关常量，在config-tool中执行gen.sh生成battle-royale-server的GameConfConstant.cs</li>\n<li>在BattlePlayer.cs中对Eliminated属性的set方法实现玩家被淘汰时触发</li>\n<li><strong>BeforeEndGame(rank:BattleRoyale.AlivePlayerMap.Count + 1)包含了更新天梯分的逻辑代码</strong></li>\n<li>此外，当用户取得第一名时会调用<strong>SuccessFinishGame来触发BeforeEndGame(rank:1)</strong></li>\n<li>投降时客户端超时</li>\n</ol>\n<p><img src=\"https://pxoqzf62udc.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDhiNTc4NWZlMGQxMjJlMzAzYTAyMTUwMzE0YTk2NDlfUGZDVDg3a21oUUwwNDFiS0dlSWNodjZhS1pLYlZ0NHBfVG9rZW46VklBcGJpZ1prb1UweFN4cVZwM2MwczBvbjl5XzE2OTMxNTAzOTY6MTY5MzE1Mzk5Nl9WNA\" alt=\"img\"></p>\n<p><img src=\"https://pxoqzf62udc.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjVmMzkzNWJhNGQ0MTY4MWQzZWUwOGNjMzUwNWJkYjlfUkV0WUxKSk1JQjV3ZUNaeHRhR3pucml4NWQwYWlZbnpfVG9rZW46Uk1tWGJIZFk3b0ljUHZ4MjRuS2NNN2o2bnZiXzE2OTMxNTAzOTY6MTY5MzE1Mzk5Nl9WNA\" alt=\"img\"></p>\n<p><img src=\"https://pxoqzf62udc.feishu.cn/space/api/box/stream/download/asynccode/?code=ODcwZDUwMGZkNTQ0Nzc3NWMzYjU2Y2U2NzVmNzExODRfbmkxTDJFS3o3Zk9oN3gwQTVSaUFiR3ZKeUdtN1l2S3pfVG9rZW46RDZpOWJPY1VHb2w5eDh4aWxOTGNUMFd5bkFoXzE2OTMxNTAzOTY6MTY5MzE1Mzk5Nl9WNA\" alt=\"img\"></p>\n<p><img src=\"https://pxoqzf62udc.feishu.cn/space/api/box/stream/download/asynccode/?code=OGJjOGRkMWQ1ODIwMTAyNmJiMWNjNjNmNjBjZTg3YWZfRm13S05nNG85TkZScEI0bTc2azllaE5HbnA3c2syQkdfVG9rZW46Slk2VmJMU1gyb1VQTHB4dW1oRGNoWjg0blljXzE2OTMxNTAzOTY6MTY5MzE1Mzk5Nl9WNA\" alt=\"img\"></p>\n<p>修改LadderGrade表中的天梯等级时报错，因为Ai那边仍旧是以前的等级策略，需要修改常量表AI的等级匹配范围。</p>\n<p>我这里测试先保留以前表的小段位置</p>\n<p><strong>Bug1</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[INFO] $battle 9 has started</span><br><span class=\"line\">not found with key:LadderGrade 9</span><br><span class=\"line\">not found with key:LadderGrade 10</span><br><span class=\"line\">not found with key:LadderGrade 11</span><br><span class=\"line\">not found with key:LadderGrade 12</span><br><span class=\"line\"></span><br><span class=\"line\">当前时间：05/27/2023 21:30:48</span><br><span class=\"line\">异常信息：Object reference not set to an instance of an object.</span><br><span class=\"line\">异常对象：project328-battle-royale-server</span><br><span class=\"line\">调用堆栈：</span><br><span class=\"line\">   at Thread.WaitingForConfirmState.FillAIUserData(List`1 realPlayerLadders, List`1 aiPlayers) in /Users/zhangcheng/.deploy-tool/src/project328-battle-royale-server/Thread/BattleState/WaitingForConfirmState.cs:line 333</span><br><span class=\"line\">   at Thread.WaitingForConfirmState.WaitConfirm() in /Users/zhangcheng/.deploy-tool/src/project328-battle-royale-server/Thread/BattleState/WaitingForConfirmState.cs:line 88</span><br><span class=\"line\">   at Thread.WaitingForConfirmState.OnEnter(ChangeStateParams param) in /Users/zhangcheng/.deploy-tool/src/project328-battle-royale-server/Thread/BattleState/WaitingForConfirmState.cs:line 58</span><br><span class=\"line\">   at StateMachine.GameStateMachine.ChangeState(Int32 newStateID, ChangeStateParams param) in /Users/zhangcheng/.deploy-tool/src/project328-battle-royale-server/csharp-hoxi-server/csharp-hoxi-server/StateMachine/GameStateMachine.cs:line 55</span><br><span class=\"line\">   at StateMachine.GameThread.HandleMessage(GameMessage gameMessage) in /Users/zhangcheng/.deploy-tool/src/project328-battle-royale-server/csharp-hoxi-server/csharp-hoxi-server/StateMachine/GameThread.cs:line 146</span><br><span class=\"line\">触发方法：Void FillAIUserData(System.Collections.Generic.List`1[System.Int32], System.Collections.Generic.List`1[ThrettleRoyalePlayer])</span><br><span class=\"line\">原始数据：System.NullReferenceException: Object reference not set to an instance of an object.</span><br><span class=\"line\">   at Thread.WaitingForConfirmState.FillAIUserData(List`1 realPlayerLadders, List`1 aiPlayers) in /Users/zhangcheng/.deploy-tool/src/project328-battle-royale-server/Thread/BattleState/WaitingForConfirmState.cs:line 333</span><br><span class=\"line\">   at Thread.WaitingForConfirmState.WaitConfirm() in /Users/zhangcheng/.deploy-tool/src/project328-battle-royale-server/Thread/BattleState/WaitingForConfirmState.cs:line 88</span><br><span class=\"line\">   at Thread.WaitingForConfirmState.OnEnter(ChangeStateParams param) in /Users/zhangcheng/.deploy-tool/src/project328-battle-royale-server/Thread/BattleState/WaitingForConfirmState.cs:line 58</span><br><span class=\"line\">   at StateMachine.GameStateMachine.ChangeState(Int32 newStateID, ChangeStateParams param) in /Users/zhangcheng/.deploy-tool/src/project328-battle-royale-server/csharp-hoxi-server/csharp-hoxi-server/StateMachine/GameStateMachine.cs:line 55</span><br><span class=\"line\">   at StateMachine.GameThread.HandleMessage(GameMessage gameMessage) in /Users/zhangcheng/.deploy-tool/src/project328-battle-royale-server/csharp-hoxi-server/csharp-hoxi-server/StateMachine/GameThread.cs:line 146</span><br></pre></td></tr></table></figure>\n<p><strong>Bug2：之前投降客户端就会投降报错的原因是因为我修改了投降发送的消息格式，但是**</strong>uds<strong><strong>中没有同步相应的</strong></strong>数据类型<strong><strong>因此就会报错，因此我们需要同时将proto生成的</strong></strong>pb<strong>**信息同步到uds中，</strong></p>\n<p>主要原因应该是修改了需要保存的历史记录的相关字段，这个字段是持久化在数据库中的，需要<strong>修改数据库</strong>的字段。</p>\n<p>bug3：在存储队友id的时候，将[]uint64的队友id列表转换为以” “为分隔符的string类型存储报错了</p>\n<figure class=\"highlight prolog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 玩家每局游戏的历史记录</span><br><span class=\"line\">type <span class=\"symbol\">UserGameHistoryRecord</span> struct &#123;</span><br><span class=\"line\">    gorm.<span class=\"symbol\">Model</span></span><br><span class=\"line\">    <span class=\"symbol\">ID</span>                uint64  <span class=\"string\">`gorm:&quot;primarykey&quot;`</span></span><br><span class=\"line\">    <span class=\"symbol\">UserID</span>            uint64  <span class=\"string\">`gorm:&quot;index:i_user_game_history&quot;`</span></span><br><span class=\"line\">    <span class=\"symbol\">GameMode</span>          uint32  <span class=\"string\">`gorm:&quot;index:i_user_game_history&quot;`</span></span><br><span class=\"line\">    <span class=\"symbol\">Result</span>            uint32  // 结果类型</span><br><span class=\"line\">    <span class=\"symbol\">BeforeLadderScore</span> int32   // 开战前天梯分</span><br><span class=\"line\">    <span class=\"symbol\">GameId</span>            uint64  <span class=\"string\">`gorm:&quot;index:i_game_id&quot;`</span></span><br><span class=\"line\">    <span class=\"symbol\">ChampionShipId</span>    uint64  <span class=\"string\">`gorm:&quot;index:i_championship_id&quot;`</span></span><br><span class=\"line\">    <span class=\"symbol\">Rank</span>              int32   // 排名</span><br><span class=\"line\">    <span class=\"symbol\">TeamRank</span>          float64 //组队平均排名</span><br><span class=\"line\">    <span class=\"symbol\">TeamPlayerIds</span>     string  //队伍id列表，以<span class=\"string\">&#x27;,&#x27;</span>分隔</span><br><span class=\"line\">    <span class=\"symbol\">EndTimeStamp</span>      uint64</span><br><span class=\"line\">    <span class=\"symbol\">TotalSec</span>          int32</span><br><span class=\"line\">    <span class=\"symbol\">HeroId</span>            int32</span><br><span class=\"line\">    <span class=\"symbol\">KeepWinCount</span>      int32</span><br><span class=\"line\">    <span class=\"symbol\">KeepFirstCount</span>    int32</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>解决方案一：直接使用string类型的话，在 Ver 14.14 Distrib 5.7.34, for Linux (x86_64) using  EditLine wrappe版本中会被映射为json</li>\n</ul>\n<h3 id=\"匹配\"><a href=\"#匹配\" class=\"headerlink\" title=\"匹配\"></a>匹配</h3><p>project328-server生成</p>\n","text":"优化排位赛的匹配规则（含单人排位和组队排位）匹配规则怎么修改，相对比较复杂，该需求可能需要延后需要open-match-function的仓库需要学习sopen-match的匹配机制单人匹配：天梯分+已解锁种族组队匹配：常量表新增字段配置，x分及以上不允许进行组队排位。同时，x分","link":"","raw":null,"photos":[],"categories":[{"name":"实习","slug":"实习","count":1,"path":"api/categories/实习.json"}],"tags":[{"name":"服务端","slug":"服务端","count":1,"path":"api/tags/服务端.json"}]}]}